<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Supervisor Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.27/"></script>
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    .toolbar {
      position: absolute; top: 10px; right: 10px; background: white;
      padding: 6px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 99; display: flex; flex-direction: column; gap: 4px; width: 120px;
    }
    .toolbar button { padding: 4px; font-size: 12px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div class="toolbar">
    <button id="saveBtn">Save Review</button>
    <button id="clearBtn">Clear All</button>
  </div>
<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer",
  "esri/widgets/Sketch", "esri/Graphic"
], function(Map, MapView, GraphicsLayer, Sketch, Graphic) {

  const params = new URLSearchParams(window.location.search);
  const formId = params.get("form_id") || "";
  const lat = parseFloat(params.get("lat")) || 25.276987;
  const lng = parseFloat(params.get("lng")) || 55.296249;
  const sketchesData = params.get("sketches") ? JSON.parse(decodeURIComponent(params.get("sketches"))) : [];

  const markerLayer = new GraphicsLayer();
  const sketchLayer = new GraphicsLayer();

  const map = new Map({ basemap: "streets-navigation-vector", layers: [markerLayer, sketchLayer] });
  const view = new MapView({ container: "viewDiv", map, center: [lng, lat], zoom: 16 });

  // Engineer's marker
  if (params.get("lat") && params.get("lng")) {
    markerLayer.add(new Graphic({
      geometry: { type: "point", longitude: lng, latitude: lat },
      symbol: { type: "simple-marker", color: "blue", size: "12px" }
    }));
  }

  // Load saved sketches
  sketchesData.forEach(g => {
    sketchLayer.add(new Graphic({
      geometry: g.geometry,
      symbol: g.symbol
    }));
  });

  // Sketch tool
  const sketch = new Sketch({
    view, layer: sketchLayer, creationMode: "update",
    visibleElements: { selectionTools: { "lasso-selection": false, "rectangle-selection": false } }
  });
  view.ui.add(sketch, "top-left");

  document.getElementById("saveBtn").onclick = () => {
    const sketchesToSave = sketchLayer.graphics.toArray().map(g => ({
      geometry: g.geometry.toJSON(),
      symbol: g.symbol
    }));
    window.parent.postMessage({
      type: "saveSupervisorSketches",
      form_id: formId,
      supervisor_sketches: JSON.stringify(sketchesToSave)
    }, "*");
    alert("Review saved.");
  };

  document.getElementById("clearBtn").onclick = () => {
    sketchLayer.removeAll();
  };
});
</script>
</body>
</html>
