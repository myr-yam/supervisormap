<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Supervisor Review Form - ArcGIS Map</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
      html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
      
      #sketchDiv {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 99;
        background: white;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      
      #controlsPanel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        width: 150px;
      }
      
      #inspectorPanel {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        max-width: 300px;
      }
      
      .panel-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        font-size: 13px;
      }
      
      .control-button {
        margin: 5px 0;
        padding: 6px 8px;
        background: #0079c1;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        width: 100%;
      }
      
      .control-button:hover {
        background: #005a87;
      }
      
      .control-button.danger {
        background: #dc3545;
      }
      
      .control-button.danger:hover {
        background: #c82333;
      }
      
      .control-button.success {
        background: #28a745;
      }
      
      .control-button.success:hover {
        background: #218838;
      }
      
      .coord-display {
        background: #e8f4fd;
        padding: 8px;
        border-radius: 4px;
        margin: 8px 0;
        font-family: monospace;
        font-size: 11px;
        color: #0066cc;
        border-left: 3px solid #0066cc;
      }
      
      .status {
        font-size: 10px;
        margin-top: 5px;
        padding: 4px;
        border-radius: 3px;
      }
      
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div id="sketchDiv"></div>
    
    <div id="controlsPanel">
      <div class="panel-title">üîß Tools</div>
      <button class="control-button success" onclick="saveReview()">üíæ Save Review</button>
      <button class="control-button danger" onclick="clearAllSketches()">üóëÔ∏è Clear All</button>
      <div id="controlStatus" class="status" style="display:none; margin-top:8px;"></div>
    </div>
    
    <div id="inspectorPanel">
      <div class="panel-title">üìç Inspection Details</div>
      <div id="formIdDisplay" class="coord-display">Form ID: Loading...</div>
      <div id="inspectorInfo" class="coord-display">Loading inspection location...</div>
      <div id="inspectionStatus" class="status info">Checking for inspection data...</div>
    </div>
    
    <script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/widgets/Sketch",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/geometry/Point"
], function(Map, MapView, Sketch, GraphicsLayer, Graphic, Point) {

  const graphicsLayer = new GraphicsLayer(); // For supervisor sketches
  const inspectorLayer = new GraphicsLayer(); // For inspector location
  let inspectionCoordinates = null;
  let currentFormId = null;
  let view, sketch;

  const map = new Map({
    basemap: "topo-vector",
    layers: [inspectorLayer, graphicsLayer]
  });

  // Function to get form ID from URL parameters or Joget form
  function getFormId() {
    // Try URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const formIdFromUrl = urlParams.get('formId');
    if (formIdFromUrl) {
      return formIdFromUrl;
    }

    // Try to get from Joget form field
    try {
      const formIdElement = window.parent.document.querySelector('[name="form_id"]');
      if (formIdElement && formIdElement.value) {
        return formIdElement.value;
      }
    } catch (e) {
      console.log("Could not access parent form:", e);
    }

    return null;
  }

  // Function to load inspection coordinates by form ID
  function loadInspectionCoordinates(formId) {
    let coordinatesData = null;
    
    try {
      // Try to get from Joget form fields first
      try {
        const latField = window.parent.document.querySelector('[name="coordinates_lat"]');
        const lngField = window.parent.document.querySelector('[name="coordinates_lng"]');
        
        if (latField && lngField && latField.value && lngField.value) {
          coordinatesData = {
            formId: formId,
            latitude: parseFloat(latField.value),
            longitude: parseFloat(lngField.value),
            timestamp: new Date().toISOString()
          };
          console.log("Coordinates loaded from Joget form:", coordinatesData);
          return coordinatesData;
        }
      } catch (e) {
        console.log("Could not access Joget form fields:", e);
      }

      // Try localStorage as backup
      const storageKey = `inspection_${formId}`;
      const savedData = localStorage.getItem(storageKey);
      
      if (savedData) {
        coordinatesData = JSON.parse(savedData);
        console.log("Coordinates loaded from localStorage:", coordinatesData);
      }
      
    } catch (error) {
      console.error("Error loading inspection coordinates:", error);
    }
    
    return coordinatesData;
  }

  // Function to display inspector location on map
  function displayInspectorLocation(lat, lon) {
    // Clear previous inspector markers
    inspectorLayer.removeAll();
    
    const point = new Point({
      longitude: lon,
      latitude: lat
    });

    const inspectorGraphic = new Graphic({
      geometry: point,
      symbol: {
        type: "simple-marker",
        color: [255, 0, 0], // Red color for inspector location
        size: 15,
        outline: {
          color: [255, 255, 255],
          width: 3
        }
      },
      attributes: {
        title: "Inspector Location",
        type: "inspection_site",
        formId: currentFormId
      },
      popupTemplate: {
        title: "üîç Inspection Site",
        content: `
          <b>Inspector Selected Location</b><br>
          <b>Latitude:</b> ${lat.toFixed(6)}<br>
          <b>Longitude:</b> ${lon.toFixed(6)}<br>
          <b>Form ID:</b> ${currentFormId}<br>
          <b>Status:</b> Under Review
        `
      }
    });

    inspectorLayer.add(inspectorGraphic);
    
    // Update info panel
    const infoDiv = document.getElementById('inspectorInfo');
    infoDiv.innerHTML = `
      <strong>üìå Site Coordinates:</strong><br>
      Lat: ${lat.toFixed(6)}<br>
      Lon: ${lon.toFixed(6)}
    `;
  }

  // Function to initialize map
  function initializeMap() {
    // Get form ID
    currentFormId = getFormId();
    
    if (!currentFormId) {
      console.error("No form ID found");
      document.getElementById('formIdDisplay').innerHTML = "‚ùå No Form ID found";
      document.getElementById('inspectorInfo').innerHTML = "‚ùå Cannot load without Form ID";
      document.getElementById('inspectionStatus').innerHTML = 
        "‚ö†Ô∏è Form ID required to load inspection data";
      return;
    }

    // Update form ID display
    document.getElementById('formIdDisplay').innerHTML = `Form ID: ${currentFormId}`;
    
    // Load inspection coordinates
    const coordinatesData = loadInspectionCoordinates(currentFormId);
    
    let centerLon = 31.2357, centerLat = 30.0444, zoomLevel = 10; // Default Cairo
    
    if (coordinatesData && coordinatesData.latitude && coordinatesData.longitude) {
      centerLon = coordinatesData.longitude;
      centerLat = coordinatesData.latitude;
      zoomLevel = 16; // Zoom close to inspection site
      inspectionCoordinates = coordinatesData;
      
      console.log("Centering map on inspection site:", centerLat, centerLon);
      
      // Update status
      document.getElementById('inspectionStatus').innerHTML = 
        `‚úÖ Inspection site loaded (${coordinatesData.timestamp ? new Date(coordinatesData.timestamp).toLocaleString() : 'No timestamp'})`;
    } else {
      console.log("No inspection coordinates found for form:", currentFormId);
      document.getElementById('inspectorInfo').innerHTML = "‚ùå No inspection location found for this form";
      document.getElementById('inspectionStatus').innerHTML = 
        "‚ö†Ô∏è No inspection coordinates available. Check if engineer submitted location.";
    }

    // Create map view
    view = new MapView({
      container: "viewDiv",
      map: map,
      center: [centerLon, centerLat],
      zoom: zoomLevel
    });

    // Create sketch widget
    sketch = new Sketch({
      layer: graphicsLayer,
      view: view,
      creationMode: "update",
      availableCreateTools: ["point", "polyline", "polygon", "rectangle", "circle"],
      container: "sketchDiv"
    });

    // When view is ready, display inspector location
    view.when(() => {
      console.log("Map view ready");
      if (inspectionCoordinates) {
        displayInspectorLocation(inspectionCoordinates.latitude, inspectionCoordinates.longitude);
        
        // Ensure map centers correctly
        setTimeout(() => {
          view.goTo({
            center: [inspectionCoordinates.longitude, inspectionCoordinates.latitude],
            zoom: 16
          });
        }, 1000);
      }
      
      // Load existing sketches
      loadExistingSketches();
    });

    // Listen for sketch events
    sketch.on("create", function(event) {
      if (event.state === "complete") {
        showControlStatus("New sketch created", "success");
      }
    });

    sketch.on("update", function(event) {
      if (event.state === "complete") {
        showControlStatus("Sketch updated", "success");
      }
    });
  }

  // Function to load existing sketches for this form
  function loadExistingSketches() {
    if (!currentFormId) return;

    try {
      // Try to get from Joget form field
      try {
        const sketchField = window.parent.document.querySelector('[name="supervisor_sketches"]');
        if (sketchField && sketchField.value) {
          const sketchData = JSON.parse(sketchField.value);
          restoreSketches(sketchData);
          return;
        }
      } catch (e) {
        console.log("Could not access Joget sketch field:", e);
      }

      // Try localStorage as backup
      const storageKey = `supervisor_review_${currentFormId}`;
      const savedData = localStorage.getItem(storageKey);
      
      if (savedData) {
        const reviewData = JSON.parse(savedData);
        if (reviewData.sketches) {
          restoreSketches(reviewData);
        }
      }
    } catch (error) {
      console.error("Error loading existing sketches:", error);
    }
  }

  // Function to restore sketches from data
  function restoreSketches(reviewData) {
    if (!reviewData.sketches) return;

    graphicsLayer.removeAll();
    let loadedCount = 0;
    
    reviewData.sketches.forEach((sketchData, index) => {
      try {
        const graphic = new Graphic({
          geometry: sketchData.geometry,
          symbol: sketchData.symbol,
          attributes: sketchData.attributes || {}
        });
        graphicsLayer.add(graphic);
        loadedCount++;
      } catch (e) {
        console.error(`Error loading sketch ${index}:`, e);
      }
    });

    if (loadedCount > 0) {
      showControlStatus(`üìÅ Loaded ${loadedCount} sketches`, "success");
    }
  }

  // Function to show control status
  function showControlStatus(message, type) {
    const statusDiv = document.getElementById('controlStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }

  // Function to save sketches to Joget form
  function saveToJogetForm(reviewData) {
    try {
      const sketchField = window.parent.document.querySelector('[name="supervisor_sketches"]');
      if (sketchField) {
        sketchField.value = JSON.stringify(reviewData);
        console.log("Sketches saved to Joget form field");
        return true;
      }
    } catch (error) {
      console.error("Error saving to Joget form:", error);
      return false;
    }
    return false;
  }

  // Function to save supervisor review
  window.saveReview = function() {
    if (!currentFormId) {
      showControlStatus("‚ùå No Form ID available", "error");
      return;
    }

    const graphics = graphicsLayer.graphics.items;
    
    console.log("Saving review - found graphics:", graphics.length);
    
    if (graphics.length === 0) {
      showControlStatus("‚ö†Ô∏è No sketches to save. Draw something first!", "error");
      return;
    }

    const reviewData = {
      formId: currentFormId,
      inspectionCoordinates: inspectionCoordinates,
      sketches: [],
      reviewTim
