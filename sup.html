<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Supervisor Review Form - ArcGIS Map</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
      html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
      
      #sketchDiv {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 99;
        background: white;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      
      #controlsPanel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        min-width: 250px;
      }
      
      #inspectorPanel {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        max-width: 350px;
      }
      
      .panel-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        font-size: 14px;
      }
      
      .control-button {
        margin: 5px 0;
        padding: 8px 12px;
        background: #0079c1;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        width: 100%;
      }
      
      .control-button:hover {
        background: #005a87;
      }
      
      .control-button.danger {
        background: #dc3545;
      }
      
      .control-button.danger:hover {
        background: #c82333;
      }
      
      .control-button.success {
        background: #28a745;
      }
      
      .control-button.success:hover {
        background: #218838;
      }
      
      .coord-display {
        background: #e8f4fd;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        color: #0066cc;
        border-left: 4px solid #0066cc;
      }
      
      .status {
        font-size: 11px;
        margin-top: 5px;
        padding: 5px;
        border-radius: 3px;
      }
      
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div id="sketchDiv"></div>
    
    <div id="controlsPanel">
      <div class="panel-title">üîß Supervisor Tools</div>
      <button class="control-button success" onclick="saveReview()">üíæ Save Review</button>
      <button class="control-button" onclick="loadSavedReview()">üìÅ Load Saved</button>
      <button class="control-button danger" onclick="clearAllSketches()">üóëÔ∏è Clear All</button>
      <button class="control-button" onclick="centerOnInspection()">üéØ Go to Site</button>
      <button class="control-button" onclick="debugSketches()" style="background:#6c757d;">üêõ Debug</button>
      <div id="controlStatus" class="status" style="display:none; margin-top:10px;"></div>
    </div>
    
    <div id="inspectorPanel">
      <div class="panel-title">üìç Inspection Site Location</div>
      <div id="inspectorInfo" class="coord-display">Loading inspection location...</div>
      <div id="inspectionStatus" class="status info">Checking for inspection data...</div>
    </div>
    
    <script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/widgets/Sketch",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/geometry/Point"
], function(Map, MapView, Sketch, GraphicsLayer, Graphic, Point) {

  const graphicsLayer = new GraphicsLayer(); // For supervisor sketches
  const inspectorLayer = new GraphicsLayer(); // For inspector location
  let inspectionCoordinates = null;
  let view, sketch;

  const map = new Map({
    basemap: "topo-vector",
    layers: [inspectorLayer, graphicsLayer]
  });

  // Function to load inspection coordinates
  function loadInspectionCoordinates() {
    let coordinatesData = null;
    
    try {
      // Try localStorage first
      let savedData = localStorage.getItem('inspectionCoordinates');
      
      if (!savedData) {
        // Try sessionStorage
        savedData = sessionStorage.getItem('inspectionCoordinates');
      }
      
      if (!savedData) {
        // Try cookies as fallback
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'inspectionCoordinates') {
            savedData = decodeURIComponent(value);
            break;
          }
        }
      }
      
      if (savedData) {
        coordinatesData = JSON.parse(savedData);
        console.log("Inspection coordinates loaded:", coordinatesData);
      }
      
    } catch (error) {
      console.error("Error loading inspection coordinates:", error);
    }
    
    return coordinatesData;
  }

  // Function to display inspector location on map
  function displayInspectorLocation(lat, lon) {
    // Clear previous inspector markers
    inspectorLayer.removeAll();
    
    const point = new Point({
      longitude: lon,
      latitude: lat
    });

    const inspectorGraphic = new Graphic({
      geometry: point,
      symbol: {
        type: "simple-marker",
        color: [255, 0, 0], // Red color for inspector location
        size: 15,
        outline: {
          color: [255, 255, 255],
          width: 3
        }
      },
      attributes: {
        title: "Inspector Location",
        type: "inspection_site"
      },
      popupTemplate: {
        title: "üîç Inspection Site",
        content: `
          <b>Inspector Selected Location</b><br>
          <b>Latitude:</b> ${lat.toFixed(6)}<br>
          <b>Longitude:</b> ${lon.toFixed(6)}<br>
          <b>Status:</b> Under Review
        `
      }
    });

    inspectorLayer.add(inspectorGraphic);
    
    // Update info panel
    const infoDiv = document.getElementById('inspectorInfo');
    infoDiv.innerHTML = `
      <strong>üìå Site Coordinates:</strong><br>
      Lat: ${lat.toFixed(6)}<br>
      Lon: ${lon.toFixed(6)}
    `;
  }

  // Function to initialize map
  function initializeMap() {
    // Load inspection coordinates
    const coordinatesData = loadInspectionCoordinates();
    
    let centerLon = 31.2357, centerLat = 30.0444, zoomLevel = 10; // Default Cairo
    
    if (coordinatesData && coordinatesData.latitude && coordinatesData.longitude) {
      centerLon = coordinatesData.longitude;
      centerLat = coordinatesData.latitude;
      zoomLevel = 16; // Zoom close to inspection site
      inspectionCoordinates = coordinatesData;
      
      console.log("Centering map on inspection site:", centerLat, centerLon);
      
      // Update status
      document.getElementById('inspectionStatus').innerHTML = 
        `‚úÖ Inspection site loaded (${coordinatesData.timestamp ? new Date(coordinatesData.timestamp).toLocaleString() : 'No timestamp'})`;
    } else {
      console.log("No inspection coordinates found, using default location");
      document.getElementById('inspectorInfo').innerHTML = "‚ùå No inspection location found";
      document.getElementById('inspectionStatus').innerHTML = 
        "‚ö†Ô∏è No inspection coordinates available. Check if engineer submitted location.";
    }

    // Create map view
    view = new MapView({
      container: "viewDiv",
      map: map,
      center: [centerLon, centerLat],
      zoom: zoomLevel
    });

    // Create sketch widget
    sketch = new Sketch({
      layer: graphicsLayer,
      view: view,
      creationMode: "update",
      availableCreateTools: ["point", "polyline", "polygon", "rectangle", "circle"],
      container: "sketchDiv"
    });

    // When view is ready, display inspector location
    view.when(() => {
      console.log("Map view ready");
      if (inspectionCoordinates) {
        displayInspectorLocation(inspectionCoordinates.latitude, inspectionCoordinates.longitude);
        
        // Ensure map centers correctly
        setTimeout(() => {
          view.goTo({
            center: [inspectionCoordinates.longitude, inspectionCoordinates.latitude],
            zoom: 16
          });
        }, 1000);
      }
    });

    // Listen for sketch events
    sketch.on("create", function(event) {
      if (event.state === "complete") {
        showControlStatus("New sketch created", "success");
      }
    });

    sketch.on("update", function(event) {
      if (event.state === "complete") {
        showControlStatus("Sketch updated", "success");
      }
    });
  }

  // Function to show control status
  function showControlStatus(message, type) {
    const statusDiv = document.getElementById('controlStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }

  // Function to save supervisor review
  window.saveReview = function() {
    const graphics = graphicsLayer.graphics.items;
    
    console.log("Saving review - found graphics:", graphics.length);
    
    if (graphics.length === 0) {
      showControlStatus("‚ö†Ô∏è No sketches to save. Draw something first!", "error");
      return;
    }

    const reviewData = {
      inspectionCoordinates: inspectionCoordinates,
      sketches: [],
      reviewTimestamp: new Date().toISOString(),
      sketchCount: graphics.length,
      reviewId: `review_${Date.now()}`
    };

    graphics.forEach((graphic, index) => {
      try {
        const sketchItem = {
          id: index,
          geometry: graphic.geometry.toJSON(),
          symbol: graphic.symbol ? graphic.symbol.toJSON() : null,
          attributes: graphic.attributes || {},
          type: graphic.geometry.type
        };
        reviewData.sketches.push(sketchItem);
        console.log(`Sketch ${index} processed:`, sketchItem.type);
      } catch (error) {
        console.error(`Error processing sketch ${index}:`, error);
      }
    });

    try {
      const reviewJson = JSON.stringify(reviewData);
      
      // Save to multiple storage locations with error handling
      try {
        localStorage.setItem('supervisorReview', reviewJson);
        console.log("Saved to localStorage");
      } catch (e) {
        console.error("localStorage save failed:", e);
      }
      
      try {
        sessionStorage.setItem('supervisorReview', reviewJson);
        console.log("Saved to sessionStorage");
      } catch (e) {
        console.error("sessionStorage save failed:", e);
      }
      
      // Save to cookie as backup
      try {
        const expirationDate = new Date();
        expirationDate.setTime(expirationDate.getTime() + (24 * 60 * 60 * 1000)); // 1 day
        document.cookie = `supervisorReview=${encodeURIComponent(reviewJson)}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Lax`;
        console.log("Saved to cookie");
      } catch (e) {
        console.error("Cookie save failed:", e);
      }
      
      // Send to parent window (Joget form)
      if (window.parent) {
        window.parent.postMessage({
          type: "supervisorReview",
          data: reviewData
        }, "*");
        console.log("Sent to parent window");
      }

      console.log("Review saved successfully:", reviewData);
      showControlStatus(`‚úÖ Review saved! (${graphics.length} sketches) ID: ${reviewData.reviewId.slice(-8)}`, "success");
      
      // Verify save by trying to read it back
      setTimeout(() => {
        const verification = localStorage.getItem('supervisorReview');
        if (verification) {
          console.log("Save verification successful");
        } else {
          console.error("Save verification failed");
        }
      }, 100);
      
    } catch (error) {
      console.error("Error saving review:", error);
      showControlStatus("‚ùå Error saving review: " + error.message, "error");
    }
  };

  // Function to load saved review
  window.loadSavedReview = function() {
    try {
      let savedData = null;
      
      // Try localStorage first
      try {
        savedData = localStorage.getItem('supervisorReview');
        if (savedData) console.log("Found data in localStorage");
      } catch (e) {
        console.error("localStorage read failed:", e);
      }
      
      // Try sessionStorage if localStorage failed
      if (!savedData) {
        try {
          savedData = sessionStorage.getItem('supervisorReview');
          if (savedData) console.log("Found data in sessionStorage");
        } catch (e) {
          console.error("sessionStorage read failed:", e);
        }
      }
      
      // Try cookies as last resort
      if (!savedData) {
        try {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'supervisorReview') {
              savedData = decodeURIComponent(value);
              console.log("Found data in cookie");
              break;
            }
          }
        } catch (e) {
          console.error("Cookie read failed:", e);
        }
      }
      
      if (savedData) {
        const reviewData = JSON.parse(savedData);
        console.log("Loading review data:", reviewData);
        
        // Clear existing sketches first
        graphicsLayer.removeAll();
        console.log("Cleared existing graphics");
        
        // Recreate sketches
        let loadedCount = 0;
        reviewData.sketches.forEach((sketchData, index) => {
          try {
            const graphic = new Graphic({
              geometry: sketchData.geometry,
              symbol: sketchData.symbol,
              attributes: sketchData.attributes || {}
            });
            graphicsLayer.add(graphic);
            loadedCount++;
            console.log(`Loaded sketch ${index}:`, sketchData.type);
          } catch (e) {
            console.error(`Error loading sketch ${index}:`, e);
          }
        });
        
        showControlStatus(`üìÅ Review loaded (${loadedCount}/${reviewData.sketches.length} sketches)`, "success");
        console.log(`Successfully loaded ${loadedCount} sketches`);
        
        // Show review info
        if (reviewData.reviewId) {
          setTimeout(() => {
            showControlStatus(`üìÅ Loaded review ID: ${reviewData.reviewId.slice(-8)}`, "info");
          }, 2000);
        }
        
      } else {
        showControlStatus("üì≠ No saved review found", "info");
        console.log("No saved review data found in any storage");
        
        // Debug: show what's in storage
        console.log("localStorage keys:", Object.keys(localStorage));
        console.log("sessionStorage keys:", Object.keys(sessionStorage));
        console.log("cookies:", document.cookie);
      }
      
    } catch (error) {
      console.error("Error loading review:", error);
      showControlStatus("‚ùå Error loading review: " + error.message, "error");
    }
  };

  // Function to clear all sketches
  window.clearAllSketches = function() {
    graphicsLayer.removeAll();
    showControlStatus("üóëÔ∏è All sketches cleared", "success");
  };

  // Function to center on inspection site
  window.centerOnInspection = function() {
    if (inspectionCoordinates) {
      view.goTo({
        center: [inspectionCoordinates.longitude, inspectionCoordinates.latitude],
        zoom: 16
      });
      showControlStatus("üéØ Centered on inspection site", "success");
    } else {
      showControlStatus("‚ùå No inspection site coordinates", "error");
    }
  };

  // Debug function to check sketches
  window.debugSketches = function() {
    const graphics = graphicsLayer.graphics.items;
    console.log("=== SKETCH DEBUG ===");
    console.log("Graphics layer items:", graphics.length);
    console.log("Graphics layer:", graphicsLayer);
    console.log("All graphics:", graphics);
    
    graphics.forEach((graphic, index) => {
      console.log(`Graphic ${index}:`, {
        geometry: graphic.geometry,
        symbol: graphic.symbol,
        type: graphic.geometry?.type
      });
    });
    
    // Check storage
    console.log("localStorage supervisorReview:", localStorage.getItem('supervisorReview'));
    console.log("sessionStorage supervisorReview:", sessionStorage.getItem('supervisorReview'));
    
    showControlStatus(`üêõ Debug: ${graphics.length} graphics found. Check console for details.`, "info");
  };

  // Initialize the map when page loads
  initializeMap();
});
</script>

  </body>
</html>
